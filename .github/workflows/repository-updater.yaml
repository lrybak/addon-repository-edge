---
name: Repository Updater

# yamllint disable-line rule:truthy
on:
  repository_dispatch:
    types: ["update"]

permissions:
  contents: write

jobs:
  publish:
    name: Publish add-on update
    runs-on: ubuntu-latest
    steps:
      - name: üîÇ Wait for other runs to complete
        uses: softprops/turnstyle@v2
        with:
          continue-after-seconds: 1200
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      # - name: üöÄ Run Repository Updater
      #   uses: hassio-addons/repository-updater@v2.0.1
      #   with:
      #     app: ${{ github.event.client_payload.app }}
      #     repository: ${{ github.repository }}
      #     token: ${{ secrets.UPDATER_TOKEN }}

      - name: üì• Checkout Code
        uses: actions/checkout@v4

      - name: ‚úèÔ∏è Apply EDGE suffix and Push
        env:
          APP_NAME: ${{ github.event.client_payload.app }}
          TARGET_FILE: "$APP_NAME/config.yaml"
        run: |
          env
          ls -l owserver

          # Fail fast - DevOps hygiene
          if [ ! -f "$TARGET_FILE" ]; then
            echo "‚ùå CRITICAL: File not found $TARGET_FILE"
            exit 1
          fi

          echo "üîç Name before change:"
          yq '.name' "$TARGET_FILE"

          # yq - inplace edit
          yq -i '.name += " EDGE"' "$TARGET_FILE"

          echo "‚úÖ after change:"
          yq '.name' "$TARGET_FILE"

          # Git config i push
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          
          git add "$TARGET_FILE"
          
          if git diff --staged --quiet; then
            echo "ü§∑ No changes to commit."
          else
            git commit -m "chore: mark $APP_NAME as EDGE"
            git push
          fi