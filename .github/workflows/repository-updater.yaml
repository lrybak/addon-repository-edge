---
name: Repository Updater

# yamllint disable-line rule:truthy
on:
  repository_dispatch:
    types: ["update"]

permissions:
  contents: write

jobs:
  publish:
    name: Publish add-on update
    runs-on: ubuntu-latest
    steps:
      - name: üîÇ Wait for other runs to complete
        uses: softprops/turnstyle@v3
        with:
          continue-after-seconds: 1200
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: üöÄ Run Repository Updater
        uses: hassio-addons/repository-updater@v2.0.1
        with:
          app: ${{ github.event.client_payload.app }}
          repository: ${{ github.repository }}
          token: ${{ secrets.UPDATER_TOKEN }}
      - name: üì• Checkout Code
        uses: actions/checkout@v6
      - name: ‚úèÔ∏è Apply channel suffix and push
        env:
          CHANNEL: EDGE
          TARGET_FILE: "config.yaml"
        run: |
          cat owserver/config.yaml
          CONFIG_FILES=$(find . -maxdepth 2 -name "$TARGET_FILE")
          if [ -z "$CONFIG_FILES" ]; then
            echo "‚ö†Ô∏è No $TARGET_FILE files found. Exiting."
            exit 1
          fi
          MODIFIED=false
          for FILE in $CONFIG_FILES; do
            echo "üìÇ Processing: $FILE"
            CURRENT_NAME=$(yq '.name' "$FILE")

            # Check if the name already contains the channel suffix (case-insensitive)
            if [[ "$CURRENT_NAME" != *"$CHANNEL" ]]; then
              echo "üíâ Adding $CHANNEL suffix to $FILE"
              yq -i ".name += \" $CHANNEL\"" "$FILE"
              MODIFIED=true
            else
              echo "‚úÖ Skipping $FILE - already has $CHANNEL suffix"
            fi
          done

          if [ "$MODIFIED" = true ]; then
            git config --global user.name "github-actions[bot]"
            git config --global user.email "github-actions[bot]@users.noreply.github.com"
            git add .
            git commit -m "‚¨ÜÔ∏è Chore: apply channel suffix to add-ons [skip ci]"
            git pull --rebase origin main
            git push
            echo "‚úÖ Changes pushed successfully."
          else
            echo "ü§∑ No changes needed."
          fi
